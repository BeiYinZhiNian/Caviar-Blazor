@using System.Web
@using Newtonsoft.Json
<CascadingAuthenticationState>
    <Router @ref="UserConfig.Router" AppAssembly="@typeof(Caviar.AntDesignUI.Config).Assembly"
            AdditionalAssemblies="Config.AdditionalAssemblies"
            PreferExactMatches="@true">
        <Found Context="routeData">
            <AuthorizeView Context="authCountext">
                <Authorized>
                    @{
                        var touristVisit = authCountext.User.Claims.SingleOrDefault(u => u.Type == CurrencyConstant.TouristVisit);
                        if(touristVisit != null)
                        {
                            UserConfig.IsTourist = bool.Parse(touristVisit.Value);
                        }
                    }
                    <ReuseTabsRouteView RouteData="@routeData" DefaultLayout="@typeof(CavMainLayout)" />
                </Authorized>
                <NotAuthorized>
                    @LoginRender()
                </NotAuthorized>
            </AuthorizeView>
        </Found>
        <NotFound>
            <Caviar.AntDesignUI.Pages.Exception._404._404></Caviar.AntDesignUI.Pages.Exception._404._404>
        </NotFound>
    </Router>
    <AntContainer />
</CascadingAuthenticationState>

@code {
    [Inject]
    UserConfig UserConfig { get; set; }

    [Inject]
    NavigationManager NavigationManager { get; set; }
    [Inject]
    HostAuthenticationStateProvider HostAuthenticationStateProvider{ get; set; }

    [Inject]
    IJSRuntime JSRuntime{ get; set; }
    [Inject]
    CavModal CavModal{ get; set; }

    RenderFragment LoginRender()
    {
        return CavModal.Render(UrlConfig.Login, "登录页面", null);
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                if (!Config.IsServer)
                {
                    //在wasm中注册事件
                    //wasm模式初始化完成，接收事件
                    IframeMessage.SwitchWasm += SwitchWasm_RefChanged;
                }
                else
                {
                    var uri = new Uri(NavigationManager.Uri);
                    var collection = HttpUtility.ParseQueryString(uri.Query);
                    //是否自动切换为wasm
                    if (!string.IsNullOrEmpty(collection["IsAutomaticSwitchWasm"]))
                    {
                        UserConfig.IsAutomaticSwitchWasm = bool.Parse(collection["IsAutomaticSwitchWasm"]);
                    }
                }
                var language = await JSRuntime.InvokeAsync<string>("getCookie", CurrencyConstant.LanguageHeader);
                UserConfig.LanguageService.SetLanguage(language);
            }
            catch
            {
                //任务被取消
            }
        }
        await base.OnAfterRenderAsync(firstRender);
    }


    private void SwitchWasm_RefChanged(IframeMessage message)
    {
        var data = message.ExchangeData;
        var json = JsonConvert.SerializeObject(data);
        var parameter = HttpUtility.UrlEncode(json);
        var url = $"{message.Url}?{CurrencyConstant.JsIframeMessage}={parameter}";
        NavigationManager.NavigateTo(url);
        JSRuntime.InvokeVoidAsync("switch_wasm");
    }

}